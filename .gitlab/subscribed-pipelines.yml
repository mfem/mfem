# Copyright (c) 2010-2024, Lawrence Livermore National Security, LLC. Produced
# at the Lawrence Livermore National Laboratory. All Rights reserved. See files
# LICENSE and NOTICE for details. LLNL-CODE-806117.
#
# This file is part of the MFEM library. For more information and source code
# availability visit https://mfem.org.
#
# MFEM is free software; you can redistribute it and/or modify it under the
# terms of the BSD-3 license. We welcome feedback and contributions, see file
# CONTRIBUTING.md for details.

# The template job to test whether a machine is up.
# Expects CI_MACHINE defined to machine name.
.machine-check:
  stage: prerequisites
  tags: [shell, oslic]
  variables:
    GIT_STRATEGY: none
  script:
    - |
      if [[ $(jq '.[env.CI_MACHINE].total_nodes_up' /usr/global/tools/lorenz/data/loginnodeStatus) == 0 ]]
      then
        echo -e "\e[31mNo node available on ${CI_MACHINE}\e[0m"
        false && \
        curl --url "https://api.github.com/repos/${GITHUB_PROJECT_ORG}/${GITHUB_PROJECT_NAME}/statuses/${CI_COMMIT_SHA}" \
             --header 'Content-Type: application/json' \
             --header "authorization: Bearer ${GITHUB_TOKEN}" \
             --data "{ \"state\": \"failure\", \"target_url\": \"${CI_PIPELINE_URL}\", \"description\": \"GitLab ${CI_MACHINE} down\", \"context\": \"ci/gitlab/${CI_MACHINE}\" }"
        exit 1
      fi

###
# Trigger a build-and-test pipeline for a machine.
# Comment the jobs for machines you donâ€™t need.
###

# One job to generate the job list for all the subpipelines
generate-job-lists:
  stage: prerequisites
  tags: [shell, oslic]
  variables:
    LOCAL_JOBS_PATH: ".gitlab/jobs"
  script:
    - |
      cat ${LOCAL_JOBS_PATH}/ruby.yml > ruby-jobs.yml
      if [[ ${AUTOTEST} == "ON" ]]
      then
          cat ${LOCAL_JOBS_PATH}/ruby-reports.yml >> ruby-jobs.yml
      fi
    - |
      cat ${LOCAL_JOBS_PATH}/lassen.yml > lassen-jobs.yml
      if [[ ${AUTOTEST} == "ON" ]]
      then
          cat ${LOCAL_JOBS_PATH}/lassen-reports.yml >> lassen-jobs.yml
      fi
    - |
      cat ${LOCAL_JOBS_PATH}/tioga.yml > tioga-jobs.yml
      if [[ ${AUTOTEST} == "ON" ]]
      then
          cat ${LOCAL_JOBS_PATH}/tioga-reports.yml >> tioga-jobs.yml
      fi
  artifacts:
    paths:
      - ruby-jobs.yml
      - lassen-jobs.yml
      - tioga-jobs.yml


# RUBY
ruby-up-check:
  variables:
    CI_MACHINE: "ruby"
  extends: [.machine-check]

ruby-build-and-test:
  variables:
    CI_MACHINE: "ruby"
    # Explicitly pass down values that we want to be able to set when triggering
    # pipelines manually or using scheduling
    AUTOTEST: "${AUTOTEST}"
    AUTOTEST_COMMIT: "${AUTOTEST_COMMIT}"
  needs: [ruby-up-check, generate-job-lists]
  extends: [.build-and-test]

# RUBY, MFEM Specific
ruby-baseline:
  stage: test-pipelines
  variables:
    # Explicitly pass down values that we want to be able to set when triggering
    # pipelines manually or using scheduling
    REBASELINE: "${REBASELINE}"
    AUTOTEST: "${AUTOTEST}"
    AUTOTEST_COMMIT: "${AUTOTEST_COMMIT}"
  trigger:
    include: .gitlab/ruby-baseline.yml
    strategy: depend
  needs: [ruby-up-check]


# TIOGA
tioga-up-check:
  variables:
    CI_MACHINE: "tioga"
  extends: [.machine-check]

tioga-build-and-test:
  variables:
    CI_MACHINE: "tioga"
    # Explicitly pass down values that we want to be able to set when triggering
    # pipelines manually or using scheduling
    AUTOTEST: "${AUTOTEST}"
    AUTOTEST_COMMIT: "${AUTOTEST_COMMIT}"
  needs: [tioga-up-check, generate-job-lists]
  extends: [.build-and-test]


# LASSEN
lassen-up-check:
  variables:
    CI_MACHINE: "lassen"
  extends: [.machine-check]

lassen-build-and-test:
  variables:
    CI_MACHINE: "lassen"
    # Explicitly pass down values that we want to be able to set when triggering
    # pipelines manually or using scheduling
    AUTOTEST: "${AUTOTEST}"
    AUTOTEST_COMMIT: "${AUTOTEST_COMMIT}"
  needs: [lassen-up-check, generate-job-lists]
  extends: [.build-and-test]
